# 变更日志 (CHANGELOG)

所有 MoonshotAI SDK 的显著变更都将记录在此文件中。

## [1.5.0] - 2024-04-01

### ✨ 新增功能
- **Web搜索功能** - 新增 `webSearch()` 方法，支持使用MoonshotAI内置的联网搜索功能
- **示例完善** - 新增 `web_search.php` 示例文件，展示如何使用网络搜索功能

### 🔄 改进
- **代码重构** - 重构 `webSearch()` 方法，使其更符合Kimi API的联网搜索规范
- **文档优化** - 更新README.md，添加网络搜索功能的详细说明和示例代码
- **兼容性提升** - 保持与现有工具调用接口的兼容性，便于从内置搜索切换到自定义搜索实现
- **注释完善** - 添加更详细的代码注释，清晰说明内置函数的使用方式

### ⚠️ 更改
- **搜索工具声明** - 使用 `"type": "builtin_function"` 替代普通 function 类型声明内置搜索工具
- **函数命名规范** - 内置函数采用 `$` 前缀（如 `$web_search`）以区分普通函数

### 🐛 修复
- 修复网络搜索Token统计的问题
- 优化搜索响应处理逻辑，提高稳定性

## [1.4.0] - 2024-03-31

### ✨ 新增功能
- **统一错误处理机制** - 新增 `MoonshotException` 类和 `ErrorHandler` 处理所有 API 错误
- **错误处理增强** - 增加详细的错误类型和错误代码，便于实现针对性错误处理
- **错误辅助方法** - 添加 `isAuthError()`, `isRateLimitError()`, `isServerError()` 等方法简化错误处理逻辑
- **示例完善** - 提供完整的错误处理示例 `examples/error_handling.php`

### 🔄 改进
- **代码重构** - 重构 API 请求错误处理逻辑，提高代码可读性和可维护性
- **重试机制优化** - 通过 `shouldRetry()` 方法判断错误是否可重试
- **日志增强** - 增强错误日志记录，提供更多错误详情
- **文档优化** - 改进 README，添加错误处理章节

### ⚠️ 更改
- **异常处理变更** - `sendRequest()` 方法现在抛出 `MoonshotException` 而不是通用 `Exception`
- **方法废弃** - 弃用 `enhanceErrorHandling()` 方法，推荐使用 `ErrorHandler::handleApiError()`

## [1.3.0] - 2024-03-28

### ✨ 新增功能
- **工具调用功能** - 添加完整的工具调用(Tool Use)功能支持，实现 `toolCall()` 和 `executeToolCall()` 方法
- **工具调用流程** - 提供自动化工具调用流程，支持函数调用结果处理

### 🔄 改进
- **响应处理优化** - 增强响应处理逻辑，添加递归调用保护
- **错误处理增强** - 更详细的错误信息和状态码
- **重试机制改进** - 支持响应头中的 Retry-After 提示
- **并发处理提升** - 提高并发处理能力，更好地处理不同类型的连接异常
- **缓存安全增强** - 增强缓存处理安全性

### 🐛 修复
- 修复截断响应处理中的参数传递问题
- 修复可能的JSON解析错误导致的异常

## [1.2.1] - 2024-03-27

### 🐛 修复
- 修复在处理被截断的响应时，递归调用未正确传递选项参数的问题
- 优化在截断响应的后续请求中，自动移除token限制以获取完整响应

## [1.2.0] - 2024-03-27

### ✨ 新增功能
- **API请求重试机制** - 当遇到 `429 Too Many Requests` 错误时自动等待并重试
- **指数退避策略** - 实现指数退避策略，每次重试增加等待时间

### 🔄 改进
- 优化 API 请求错误处理逻辑
- 增强日志记录，提供更详细的重试信息

## [1.1.0] - 2024-03-27

### ✨ 新增功能
- **Vision API 支持** - 使用 `vision()` 方法可发送带图像的请求
- **Vision消息构建** - 添加 `createVisionMessage()` 方法构建 Vision 消息
- **模型列表查询** - 添加 `listModels()` 方法获取可用模型列表
- **历史清除** - 添加 `clearHistory()` 方法清除对话历史
- **模型设置** - 添加 `setModelType()` 方法设置模型类型

### 🔄 改进
- **错误处理** - 改进错误处理，所有API方法现在会抛出异常而不是返回空字符串
- **参数扩展** - 添加 `options` 参数支持，可传入温度、最大token等参数
- **流式响应** - 改进流式响应处理
- **文档完善** - 完善文档注释
- **代码结构** - 优化代码结构和模块化

### ⚠️ 更改
- **默认模型变更** - 默认模型从 'moonshot-v1-auto' 改为 'moonshot-v1-8k'
- **方法签名调整** - `moonshot($query)` 改为 `moonshot($query, array $options = [])`

### 🐛 修复
- 修复并发请求处理问题
- 修复流式响应处理逻辑

## [1.0.0] - 2024-03-25

### ✨ 初始版本
- 基本的聊天功能实现
- 文件上传和处理功能
- Token 计算功能
- 余额查询功能 